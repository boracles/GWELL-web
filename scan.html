<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>장내자산 스캔 — Scan</title>

    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="apple-mobile-web-app-title" content="장내자산 스캔" />
    <link rel="apple-touch-icon" href="/Icon.png" />
    <link rel="manifest" href="/manifest.json" />

    <link rel="stylesheet" href="assets/css/style.css" />

    <script src="https://unpkg.com/@supabase/supabase-js@2.48.0/dist/umd/supabase.js"></script>
    <script src="assets/js/supabase-init.js"></script>
    <!-- three.js import map -->
    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js"
        }
      }
    </script>

    <script type="module">
      import * as THREE from "three";
      import { GLTFLoader } from "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/loaders/GLTFLoader.js";

      // 전역에서 쓸 수 있게 window에만 붙이기 (네임스페이스는 건드리지 않기)
      window.THREE = THREE;
      window.GLTFLoader = GLTFLoader;
    </script>

    <!-- 그 다음에 scan.js (예전 그대로) -->
    <script src="assets/js/scan.js" defer></script>
  </head>
  <body>
    <div class="app app--scan">
      <!-- Standby 화면: 파티클 + 힌트 한 줄 -->
      <div id="standbyScreen" class="standby-screen">
        <div class="standby-bg"></div>
        <canvas id="standbyParticles"></canvas>
        <div class="standby-center">
          <div class="standby-hint" id="standbyHint">
            착석 시 스캔 절차가 시작됩니다.
          </div>
        </div>
      </div>

      <!-- 실제 스캔 UI 헤더 (이게 scanHeader) -->
      <header class="app-header" id="scanHeader">
        <div class="app-header__titles">
          <h1 class="app-title">장내자산 스캔</h1>
        </div>
        <!-- 실제 설치에선 숨겨도 되는 디버그 버튼 -->
        <button class="app-cta" id="debugStartBtn">디버그: 시퀀스 시작</button>
      </header>

      <!-- 스캔 메인 영역 (이게 scanRoot) -->
      <div class="scan-root" id="scanRoot">
        <div class="scan-main">
          <div class="scan-bg particles" id="scanBg"></div>

          <!-- 🔹 3D 미생물 레이어 -->
          <canvas id="scanMicrobes"></canvas>

          <div class="scan-content">
            <div class="scan-posture" id="scanPosture" style="display: none">
              <!-- 제목 + 고정 안내 문구 (인포그래픽 위) -->
              <div class="posture-message">올바른 자세로 앉아 주세요.</div>

              <div class="posture-sub posture-sub-soft" id="postureLine4">
                잠시 동안 이 자세를 유지하면 스캔이 자동으로 시작됩니다.
              </div>

              <!-- 인포그래픽 -->
              <div class="posture-graphic">
                <img
                  src="assets/img/Sit.svg"
                  class="posture-img posture-img--idle"
                  id="postureImg"
                  alt="올바른 착석 자세 인포그래픽"
                />
              </div>

              <!-- 🔹 여기가 “한 줄씩 바뀌어 나오는” 자리 (하나만) -->
              <div class="posture-sub posture-line" id="postureSequenceText">
                <!-- JS에서 문장 교체함 -->
              </div>

              <div class="posture-stepper">
                <div class="posture-progress-bar">
                  <div
                    class="posture-progress-bar-inner"
                    id="postureProgressInner"
                  ></div>
                </div>
                <div class="posture-stepper-dots">
                  <!-- 🔹 시작 지점: 공간만 차지, 실제 단계 아님 -->
                  <div class="posture-step posture-step--start">
                    <span class="posture-step-dot"></span>
                  </div>

                  <!-- 🔹 1단계 -->
                  <div class="posture-step" data-step="0">
                    <span class="posture-step-dot"></span>
                    <span class="posture-step-check">✔</span>
                  </div>

                  <!-- 🔹 2단계 -->
                  <div class="posture-step" data-step="1">
                    <span class="posture-step-dot"></span>
                    <span class="posture-step-check">✔</span>
                  </div>

                  <!-- 🔹 3단계 -->
                  <div class="posture-step" data-step="2">
                    <span class="posture-step-dot"></span>
                    <span class="posture-step-check">✔</span>
                  </div>

                  <!-- 🔹 4단계 -->
                  <div class="posture-step" data-step="3">
                    <span class="posture-step-dot"></span>
                    <span class="posture-step-check">✔</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- 상단 상태 블럭 -->
            <div class="scan-top-row" id="scanTopRow">
              <div class="scan-status-block">
                <div>
                  <span class="label">PIR:</span>
                  <span class="val" id="statusPir">OFF</span>
                </div>
                <div>
                  <span class="label">Pressure:</span>
                  <span class="val" id="statusPressure">OFF</span>
                </div>
                <div>
                  <span class="label">System:</span>
                  <span class="val" id="statusSystem">IDLE</span>
                </div>
              </div>
              <div class="scan-status-block" style="text-align: right">
                <div>
                  <span class="label">Phase:</span>
                  <span class="val" id="statusPhase">A0-1</span>
                </div>
                <div>
                  <span class="label">Timer:</span>
                  <span class="val" id="statusTimer">00:00</span>
                </div>
              </div>
            </div>

            <!-- 메인 메시지 -->
            <div class="scan-main-message" id="scanMainMessage">
              <h2 id="mainMessage">대기 중입니다.</h2>
              <p id="subMessage">
                관람객 접근 전, 시스템은 장내자산 스캔을 준비하고 있습니다.
              </p>
              <div class="scan-secondary" id="secondaryMessage">
                변기 근처에 다가오면 시스템이 자동으로 깨어납니다.
              </div>
            </div>

            <!-- 경고 / 결과 -->
            <div
              class="scan-warning"
              id="warningMessage"
              style="display: none"
            ></div>
            <div
              class="scan-result-list"
              id="resultList"
              style="display: none"
            ></div>

            <!-- 하단: 진행/정제율/버튼 -->
            <div class="scan-bottom" id="scanBottom">
              <div class="scan-progress-row" id="progressRow">
                <div id="progressLabel">스캔 대기</div>
                <div id="progressTime">00:00 / 00:30</div>
              </div>
              <div class="scan-progress-bar" id="progressBar">
                <div
                  class="scan-progress-bar-inner"
                  id="progressBarInner"
                ></div>
              </div>

              <div class="scan-purity-row" id="purityRow">
                <div>
                  <span class="scan-tag">정제율</span>
                  <span id="purityValue">0%</span>
                </div>
                <div id="remainingTime">남은 시간: -</div>
              </div>

              <div
                class="scan-buttons-row"
                id="decisionButtons"
                style="display: none"
              >
                <button class="scan-btn-ghost" id="btnNo">
                  NO · 상장하지 않기
                </button>
                <button class="scan-btn-primary" id="btnYes">
                  YES · 사회 자산으로 상장
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
